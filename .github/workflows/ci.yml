name: ğŸš€ ShipOS CI

on:
  push:
    branches: [ main, dev*, feat/** ]
  pull_request:
    branches: [ main, dev* ]

jobs:
  build-and-test:
    name: ğŸ”§ Build & Test ShipOS
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ” Updating system packages..."
        sudo apt-get update
        echo "ğŸ“¦ Installing required tools..."
        sudo apt-get install -y \
          grub-pc-bin \
          grub-common \
          xorriso \
          mtools \
          qemu-system-x86 \
          nasm \
          gcc \
          make
        echo "âœ¨ Dependencies installed!"

    - name: ğŸ—ï¸ Build Kernel & ISO
      run: |
        echo "ğŸ› ï¸ Building kernel ISO..."
        make build_iso
        echo "ğŸ‰ Build completed"

    - name: ğŸ” Verify kernel binary exists
      run: |
        echo "ğŸ“ Checking kernel.bin..."
        if [ ! -f isofiles/boot/kernel.bin ]; then
          echo "âŒ Error: kernel.bin not found!"
          exit 1
        fi
        echo "âœ… Kernel binary found!"
        echo "ğŸ“ Size: $(stat -c%s isofiles/boot/kernel.bin) bytes"

    - name: ğŸ” Verify ISO exists
      run: |
        echo "ğŸ“ Checking kernel.iso..."
        if [ ! -f isofiles/kernel.iso ]; then
          echo "âŒ Error: kernel.iso not found!"
          exit 1
        fi
        echo "âœ… ISO found!"
        echo "ğŸ“ Size: $(stat -c%s isofiles/kernel.iso) bytes"

    - name: ğŸ§ª Boot test with QEMU (10 seconds)
      run: |
        echo "ğŸ–¥ï¸ Starting QEMU boot test (headless, 10s)..."
        timeout 10s make qemu-headless 2>&1 || true
        echo "ğŸ“œ === Boot log ==="
        cat serial.log
        echo "ğŸ“œ === End of boot log ==="
        cp serial.log kernel_boot.log
        echo "ğŸ“ Boot log saved"

    - name: ğŸ§ Validate boot success
      run: |
        echo "ğŸ” Checking for expected boot messages..."

        check() {
          if grep -q "$2" kernel_boot.log; then
            echo "âœ… $1"
          else
            echo "âŒ $1 missing!"
            exit 1
          fi
        }

        check "Serial port initialized" "\[SERIAL\] Serial port COM1 initialized successfully"
        check "TTY subsystem initialized" "\[BOOT\] TTY subsystem initialized"
        check "Memory subsystem initialized" "\[MEMORY\] Physical memory initialized"
        check "Kernel boot completed" "\[KERNEL\] Boot sequence completed successfully"

        echo "ğŸ‰ All boot checks passed!"

    - name: ğŸš¨ Check for panic or errors
      run: |
        echo "ğŸ” Scanning for critical issues..."

        if grep -i "panic" kernel_boot.log; then
          echo "ğŸ”¥ PANIC detected in kernel log!"
          exit 1
        fi

        if grep -i "error" kernel_boot.log; then
          echo "âš ï¸ Errors found in boot log:"
          grep -i "error" kernel_boot.log
        else
          echo "âœ¨ No errors found"
        fi

    - name: ğŸ“¤ Upload boot log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ğŸ“ kernel-boot-log
        path: kernel_boot.log
        retention-days: 30

    - name: ğŸ“¤ Upload kernel binary & ISO
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ğŸ§© Kernel build artifacts
        path: |
          isofiles/boot/kernel.bin
          isofiles/kernel.iso
        retention-days: 30
