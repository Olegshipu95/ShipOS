name: ShipOS CI

on:
  push:
    branches: [ main, dev*, feat/** ]
  pull_request:
    branches: [ main, dev* ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          grub-pc-bin \
          grub-common \
          xorriso \
          mtools \
          qemu-system-x86 \
          nasm \
          gcc \
          make
    
    - name: Build kernel
      run: make build_iso
    
    - name: Check kernel binary exists
      run: |
        if [ ! -f isofiles/boot/kernel.bin ]; then
          echo "Error: kernel.bin not found!"
          exit 1
        fi
        echo "Kernel binary size: $(stat -c%s isofiles/boot/kernel.bin) bytes"
    
    - name: Check ISO exists
      run: |
        if [ ! -f isofiles/kernel.iso ]; then
          echo "Error: kernel.iso not found!"
          exit 1
        fi
        echo "ISO size: $(stat -c%s isofiles/kernel.iso) bytes"
    
    - name: Boot test with QEMU (10 seconds)
      run: |
        echo "Starting QEMU boot test in headless mode..."
        timeout 10s make qemu-headless 2>&1 || true
        echo "=== Boot log ==="
        cat serial.log
        echo "=== End of boot log ==="
        cp serial.log kernel_boot.log
    
    - name: Check for successful boot indicators
      run: |
        if grep -q "\[SERIAL\] Serial port COM1 initialized successfully" kernel_boot.log; then
          echo "✓ Serial port initialized"
        else
          echo "✗ Serial port initialization not found"
          exit 1
        fi
        
        if grep -q "\[BOOT\] TTY subsystem initialized" kernel_boot.log; then
          echo "✓ TTY subsystem initialized"
        else
          echo "✗ TTY subsystem initialization not found"
          exit 1
        fi
        
        if grep -q "\[MEMORY\] Physical memory initialized" kernel_boot.log; then
          echo "✓ Memory subsystem initialized"
        else
          echo "✗ Memory subsystem initialization not found"
          exit 1
        fi
        
        if grep -q "\[KERNEL\] Boot sequence completed successfully" kernel_boot.log; then
          echo "✓ Kernel boot completed"
        else
          echo "✗ Kernel boot completion not found"
          exit 1
        fi
        
        echo "All boot checks passed!"
    
    - name: Check for panic or errors
      run: |
        if grep -i "panic" kernel_boot.log; then
          echo "✗ Panic detected in boot log!"
          exit 1
        fi
        
        if grep -i "error" kernel_boot.log; then
          echo "⚠ Warning: Error messages detected in boot log"
          grep -i "error" kernel_boot.log
        fi
        
        echo "No critical errors detected"
    
    - name: Upload boot log artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-boot-log
        path: kernel_boot.log
        retention-days: 30
    
    - name: Upload kernel binary
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-binary
        path: |
          isofiles/boot/kernel.bin
          isofiles/kernel.iso
        retention-days: 30
