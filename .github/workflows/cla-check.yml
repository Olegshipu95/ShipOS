name: üîè Contributor Assignment Agreement Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  cla-check:
    name: Check Contributor Assignment Agreement Signature
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.issue.pull_request)
    permissions:
      issues: write
      pull-requests: write
      statuses: write
      contents: read
      checks: read
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: üîç Check if PR author has signed Contributor Assignment Agreement
      id: cla_check
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prNumber = context.payload.pull_request.number;
          const author = context.payload.pull_request.user.login;
          const sha = context.payload.pull_request.head.sha;
          
          console.log(`Checking Contributor Assignment Agreement for contributor: ${author}`);
          
          // Check if CLA Assistant has already verified (license/cla check)
          let claSigned = false;
          
          try {
            const checks = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: sha,
            });
            
            const claCheck = checks.data.check_runs.find(
              check => check.name === 'license/cla' || check.name.includes('CLA') || check.name.includes('cla')
            );
            
            if (claCheck && claCheck.conclusion === 'success') {
              console.log('‚úÖ CLA Assistant has verified the signature');
              claSigned = true;
            } else {
              console.log('‚ö†Ô∏è CLA Assistant check not found or not successful');
            }
          } catch (error) {
            console.log('Could not check CLA Assistant status:', error.message);
          }
          
          // Also check PR comments for manual signature
          if (!claSigned) {
            try {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });
              
              const signatureComment = comments.data.find(comment => 
                comment.user.login === author &&
                (comment.body.includes('I have read the CONTRIBUTOR_ASSIGNMENT.md') ||
                 comment.body.includes('I hereby sign the Contributor Assignment Agreement'))
              );
              
              if (signatureComment) {
                console.log('‚úÖ Found manual signature comment');
                claSigned = true;
              }
            } catch (error) {
              console.log('Could not check comments:', error.message);
            }
          }
          
          // Set output for next steps
          const fs = require('fs');
          const outputPath = process.env.GITHUB_OUTPUT || '/tmp/github_output';
          fs.appendFileSync(outputPath, `cla_signed=${claSigned.toString()}\n`);
          console.log(`CLA signed status: ${claSigned}`);
    
    - name: üìù Comment on PR
      if: steps.cla_check.outputs.cla_signed == 'false' && github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened')
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prNumber = context.payload.pull_request.number;
          const author = context.payload.pull_request.user.login;
          
          // Check if a comment from this bot already exists
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          
          const botComment = comments.data.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('üîè Contributor Assignment Agreement Required')
          );
          
          // Only post if no existing comment found
          if (!botComment) {
            const comment = `## üîè Contributor Assignment Agreement Required
          
          Thank you for your contribution, @${author}!
          
          Before we can review and merge your pull request, you need to sign our [Contributor Assignment Agreement](CONTRIBUTOR_ASSIGNMENT.md).
          
          ### üìã What is the Contributor Assignment Agreement?
          
          The Contributor Assignment Agreement ensures that all contributions to ShipOS become the exclusive property of the project owner. This allows ShipOS to:
          - Maintain exclusive ownership of all code
          - Control distribution and licensing
          - Commercialize the project if desired
          
          ### ‚úçÔ∏è How to Sign
          
          1. **Read the Contributor Assignment Agreement:** Please carefully read the [CONTRIBUTOR_ASSIGNMENT.md](CONTRIBUTOR_ASSIGNMENT.md) document
          2. **Sign via CLA Assistant:** If you have the CLA Assistant app installed, it will prompt you automatically
          3. **Manual Signing:** If CLA Assistant is not available, please comment on this PR with:
             \`\`\`
             I have read the CONTRIBUTOR_ASSIGNMENT.md and agree to its terms. I hereby sign the Contributor Assignment Agreement.
             \`\`\`
          
          ### ‚ö†Ô∏è Important
          
          By signing the Contributor Assignment Agreement, you agree that:
          - All your contributions (past, present, and future) become the exclusive property of ShipOS
          - ShipOS has full rights to use, modify, distribute, and commercialize your contributions
          - You grant ShipOS all necessary rights and licenses
          
          Once you've signed, this check will be updated automatically.
          
          ---
          
          **Note:** This is an automated check. For the best experience, install the [CLA Assistant GitHub App](https://github.com/apps/cla-assistant).`;
            
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
    
    - name: ‚úÖ Set PR status
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prNumber = context.payload.pull_request.number;
          const sha = context.payload.pull_request.head.sha;
          const claSigned = '${{ steps.cla_check.outputs.cla_signed }}' === 'true';
          
          try {
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha,
              state: claSigned ? 'success' : 'pending',
              target_url: `${context.payload.repository.html_url}/blob/main/CONTRIBUTOR_ASSIGNMENT.md`,
              description: claSigned 
                ? 'Contributor Assignment Agreement has been signed ‚úì' 
                : 'Contributor Assignment Agreement signature required - please sign the Contributor Assignment Agreement',
              context: 'cla/signature'
            });
            console.log(`Status check set to: ${claSigned ? 'success' : 'pending'}`);
          } catch (error) {
            console.error('Failed to set status check:', error);
            core.setFailed(`Failed to set status check: ${error.message}`);
          }

